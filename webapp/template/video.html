{{define "video"}} {{template "header" .}}

<div class="content">

 <h2>SCIONLab Video</h2>
 WIP testing for WebRTC -- DANGER! -- There be dragons here.
</div>


<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
<!-- TODO: API update <script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-app.js"></script> -->
<link
 href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"
 rel="stylesheet">


<style>
video {
 background-color: #ddd;
 border-radius: 7px;
 margin: 10px 0px 0px 10px;
 width: 320px;
 height: 240px;
}

button {
 margin: 5px 0px 0px 10px !important;
 width: 654px;
}
</style>


<div id="videoFrame">
 <video id="yourVideo" autoplay muted></video>
 <video id="friendsVideo" autoplay></video>
 <br />
 <button onclick="showFriendsFace()" type="button"
  class="btn btn-primary btn-lg">
  <span class="glyphicon glyphicon-facetime-video" aria-hidden="true"></span>
  Call
 </button>
</div>

<script type="text/javascript">
    document.getElementById("videoFrame").onload = function() {
        ajaxConfig();
    };

    function ajaxConfig() {
        return $.ajax({
            url : 'config',
            type : 'get',
            dataType : "json",
            //data : g,
            timeout : 30000,
            success : isRTCConfigComplete,
            error : function(jqXHR, textStatus, errorThrown) {
                console.log(this.url + ' ' + textStatus + ': ' + errorThrown);
            },
        });
    }

    // App's Firebase configuration
    var firebaseConfig = {
        authDomain: "wip-scion-webrtc.firebaseapp.com",
        databaseURL: "https://wip-scion-webrtc.firebaseio.com",
        projectId: "wip-scion-webrtc",
        storageBucket: "wip-scion-webrtc.appspot.com",
    };

    var servers = {
            'iceServers' : [ {
                'urls' : 'stun:stun.services.mozilla.com'
            }, {
                'urls' : 'stun:stun.l.google.com:19302'
            }, {
                'urls': 'turn:numb.viagenie.ca',
                'credential': '<your TURN password>',
                'username': '<your TURN username>'
            } ]
        };
    var pc = new RTCPeerConnection(servers);
    var yourVideo = document.getElementById("yourVideo");
    var friendsVideo = document.getElementById("friendsVideo");
    var yourId = Math.floor(Math.random() * 1000000000);
    var database;


    function isRTCConfigComplete(data, textStatus, jqXHR) {
        firebaseConfig.apiKey = data.webrtc_apiKey;
        firebaseConfig.messagingSenderId = data.webrtc_messagingSenderId;
        firebaseConfig.appId = data.webrtc_appId;
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        database = firebase.database().ref();

        pc.onicecandidate = (event => event.candidate?sendMessage(yourId, JSON.stringify({'ice': event.candidate})):console.log("Sent All Ice") );
        pc.onaddstream = (event => friendsVideo.srcObject = event.stream);

        database.on('child_added', readMessage);

        // when load finished...
        showMyFace();
    }

    function sendMessage(senderId, data) {
        var msg = database.push({
            sender : senderId,
            message : data
        });
        msg.remove();
    }

    function readMessage(data) {
        var msg = JSON.parse(data.val().message);
        var sender = data.val().sender;
        if (sender != yourId) {
            if (msg.ice != undefined)
                pc.addIceCandidate(new RTCIceCandidate(msg.ice));
            else if (msg.sdp.type == "offer")
                pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))
                 .then(() => pc.createAnswer())
                 .then(answer => pc.setLocalDescription(answer))
                 .then(() => sendMessage(yourId, JSON.stringify({'sdp': pc.localDescription})));
            else if (msg.sdp.type == "answer")
                pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
        }
    };


    function showMyFace() {
        navigator.mediaDevices.getUserMedia({audio:true, video:true})
         .then(stream => yourVideo.srcObject = stream)
         .then(stream => pc.addStream(stream));
    }

    function showFriendsFace() {
        pc.createOffer()
              .then(offer => pc.setLocalDescription(offer) )
              .then(() => sendMessage(yourId, JSON.stringify({'sdp': pc.localDescription})) );
    }

</script>

{{template "footer" .}} {{end}}
